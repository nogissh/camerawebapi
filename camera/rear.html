<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>リアカメラ</title>
</head>
<body>
<h1>リアカメラ</h1>
<video id="video" autoplay playsinline></video>
<div>
    <h2>結果</h2>
    <p id="result"></p>
</div>
<p><a href="/camerawebapi/camera/front.html">フロントカメラを使う</a></p>
<div style="display:none">
    <canvas id="canvas"></canvas>
</div>

<script src="/camerawebapi/static/js/jsQR.js"></script>
<script>
var video = document.getElementById('video');

navigator.mediaDevices.getUserMedia({
    audio: false,
    video: {
        facingMode: 'user'
    }
})
.then(function (stream) {
    video.srcObject = stream;
})
.catch(function () {
    alert('カメラの起動に失敗しました。');
});

var canvas = document.getElementById('canvas');
var ctx = canvas.getContext('2d');

var checkImage = () => {
    ctx.drawImage(vide, 0, 0, canvas.width, canvas.height);

    var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

    var code = jsQR(imageData.data, canvas.width, canvas.height);

    if (code) {
        document.getElementById('result').innerHTML = code.data;
    } else {
        setTimeout(() => { checkImage() }, 200)
    }
}
</script>
</body>
</html>
